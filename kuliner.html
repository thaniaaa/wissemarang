<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <title>Cyborg - Awesome HTML5 Template</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">


    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-cyborg-gaming.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet"href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>


    <style>

      .favorite-icon {
          position: absolute;
          top: 10px;
          right: 10px;
          font-size: 24px;
          color: red;
          cursor: pointer;
          transition: 0.3s;
          background: #d2d2d2;
          border-radius: 50%;
          padding: 5px;
      }

      .favorite-icon:hover {
          color: darkred;
      }
  </style>
  </head>

<body>

  <!-- ***** Preloader Start ***** -->
  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
      <span class="dot"></span>
      <div class="dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
  <!-- ***** Preloader End ***** -->

  <!-- ***** Header Area Start ***** -->
  <header class="header-area header-sticky">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="main-nav">
                    <!-- ***** Logo Start ***** -->
                    <a href="index.html" class="logo">
                        <img src="assets/images/logo.png" alt="">
                    </a>
                    <!-- ***** Logo End ***** -->
                     <!-- ***** Menu Start ***** -->
                     <ul class="nav">
                      <li><a href="index.html" class="active">Home</a></li>
                      <li><a href="index.html#kategori-wisata">Kategori</a></li>
                      <li><a href="index.html#tempat-populer">Populer</a></li>
                      <li><a href="favorite.html">Favorite</a></li> 
                      <li><a href="profile.html">Profile</a></li>
                  </ul>   
                  <a class='menu-trigger'>
                      <span>Menu</span>
                  </a>
                  <!-- ***** Menu End ***** -->
                </nav>
            </div>
        </div>
    </div>
  </header>
  <!-- ***** Header Area End ***** -->

  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="page-content">

          <!-- ***** kuliner Popular Section ***** -->
          <div class="row">
            <div class="col-lg-8">
              <div class="featured-games header-text">
                <div class="heading-section">
                  <h4><em>Kuliner</em> Popular</h4>
                </div>
                <div id="kuliner-carousel" class="owl-carousel owl-theme">
                  <!-- Data kuliner akan dimasukkan di sini oleh JavaScript -->
                </div>
              </div>
            </div>
            
            <div class="col-lg-4">
              <div class="top-streamers">
                  <div class="heading-section">
                      <h4><em>Fakta</em> Semarang</h4>
                  </div>
                  <img src="wisata-backend\wisataImage\wingkobabat.jpg" alt="Kota Semarang" class="img-fluid rounded mb-3">
                  <p>Wingko Babat adalah kudapan tradisional berbahan dasar kelapa dan tepung ketan yang kini menjadi ikon kuliner khas Semarang.
                     Meski berasal dari Babat, Lamongan, makanan ini mulai populer setelah dibawa ke Semarang pada tahun 1946 dan dijajakan di
                      sekitar Stasiun Tawang. </p>
              </div>
          </div>
          <!-- ***** Featured Games End ***** -->

          <!-- ***** List Kuliner Section ***** -->
          <div class="live-stream">
            <div class="col-lg-12">
              <div class="heading-section">
                <h4><em>Kuliner </em> di Kota Semarang</h4>
              </div>
            </div>
            <div id="kuliner-list" class="row">
              <!-- Data kuliner akan dimasukkan di sini oleh JavaScript -->
          </div>
          </div>
          <!-- ***** Live Stream End ***** -->

        </div>
      </div>
    </div>
  </div>
  <!-- <div class="container mt-4">
    <h2>Kuliner Populer</h2>
    <div id="kuliner-list" class="row"></div>  Data kuliner akan dimasukkan di sini -->
</div>

  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <p>Pemerintah Kota Semarang ©2025. <a href="#"> All Rights Reserved. </a> Created by <span class="blue-text">Diskominfo Kota Semarang</span>.</p>

          
          <!-- <br>Design: <a href="https://templatemo.com" target="_blank" title="free CSS templates">TemplateMo</a></p> -->
        </div>
      </div>
    </div>
  </footer>


  <!-- Scripts -->
  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

  <script src="assets/js/isotope.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/tabs.js"></script>
  <script src="assets/js/popup.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", function () {
  const token = localStorage.getItem('token');  // Ambil token dari localStorage

  fetch("http://localhost:5000/api/wisata/kategori/Kuliner")
    .then(response => response.json())
    .then(data => {
      if (!Array.isArray(data)) {
        console.error("Data tidak valid:", data);
        return;
      }

      // // Sorting berdasarkan rating tertinggi
      // data.sort((a, b) => b.rating - a.rating);

      // Menampilkan data wisata ke carousel
      const kulinerCarousel = document.getElementById("kuliner-carousel");
      kulinerCarousel.innerHTML = "";

      data.slice(0, 5).forEach(wisata => { // Hanya ambil 5 kuliner untuk carousel
        const item = document.createElement("div");
        item.classList.add("item");

        item.innerHTML = `
          <div class="thumb">
            <img src="http://localhost:5000/${wisata.foto}" alt="${wisata.nama_tempat}">
          </div>
          <h4>${wisata.nama_tempat}<br>
          
        `;

        // Menambahkan event listener untuk mengarahkan ke halaman detail
        item.addEventListener('click', function () {
          window.location.href = `detailWisata.html?id=${wisata.id}`;
        });

        kulinerCarousel.appendChild(item);
      });

      // Inisialisasi carousel
      $(".owl-carousel").owlCarousel({
        items: 3,
        loop: true,
        autoplay: true,
        autoplayTimeout: 3000,
        dots: false
      });

      // Tampilkan daftar kuliner di Kota Semarang
      const kulinerList = document.getElementById("kuliner-list");
      kulinerList.innerHTML = "";

      // Memeriksa daftar favorit jika ada
      let favoritePlaces = [];
      if (token) {
        const userId = JSON.parse(atob(token.split('.')[1])).id; // Mendekode JWT untuk mendapatkan userId
        fetch(`http://localhost:5000/api/favorite/${userId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
          .then(response => response.json())
          .then(favorites => {
            favoritePlaces = favorites.map(fav => fav.id); // Daftar ID favorit
            renderWisata(data, favoritePlaces); // Render wisata dengan status favorit
          })
          .catch(error => console.error("Error fetching favorite places:", error));
      } else {
        renderWisata(data, favoritePlaces); // Render wisata jika user tidak login
      }
    })
    .catch(error => console.error("Gagal mengambil data wisata:", error));
});

// Memanggil fungsi saat halaman dimuat
document.addEventListener("DOMContentLoaded", loadTopRatedKotaLama);


function renderWisata(wisataList, favoritePlaces) {
  const kulinerList = document.getElementById("kuliner-list");

  wisataList.forEach(wisata => {
    const wisataItem = document.createElement("div");
    wisataItem.classList.add("col-lg-3", "col-sm-6", "mb-4");

    const isFavorited = favoritePlaces.includes(wisata.id);

    wisataItem.innerHTML = `
      <div class="item">
        <div class="thumb">
          <img src="http://localhost:5000/${wisata.foto}" alt="${wisata.nama_tempat}">
          <div class="hover-effect">
            <div class="content">
              <div class="live">
                <i class="favorite-icon ${isFavorited ? 'fa-solid' : 'fa-regular'} fa-heart" data-id="${wisata.id}" onclick="toggleFavorite(this, event)"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="down-content">
          <h4>${wisata.nama_tempat}</h4>
          <p>${wisata.deskripsi.substring(0, 100)}...</p>
          <!-- Menampilkan rata-rata rating dengan ID dinamis berdasarkan ID wisata -->
          <div class="average-rating" id="average-rating-${wisata.id}">⭐</div>  
        </div>
      </div>
    `;

    // Menambahkan event listener untuk mengarahkan ke halaman detail
    wisataItem.addEventListener('click', function () {
      window.location.href = `detailWisata.html?id=${wisata.id}`;
    });

    kulinerList.appendChild(wisataItem);

    // Memanggil fungsi untuk menampilkan rata-rata rating untuk wisata ini
    loadAverageRating(wisata.id);
  });
}

// Fungsi untuk menampilkan rata-rata rating
function loadAverageRating(wisataId) {
  fetch(`http://localhost:5000/api/rating/wisata/${wisataId}`)
    .then(response => response.json())
    .then(data => {
      const averageRating = data.averageRating || 0; // Ambil rata-rata rating
      const ratingElement = document.getElementById(`average-rating-${wisataId}`);
      ratingElement.innerHTML = `Rating: ${averageRating.toFixed(1)} ⭐`;
    })
    .catch(error => {
      console.error('Error fetching average rating:', error);
    });
}

// Fungsi untuk toggle favorit
function toggleFavorite(icon, event) {
  event.stopPropagation(); // Stop event propagation to prevent triggering click event

  const token = localStorage.getItem('token');  // Ambil token dari localStorage
  if (!token) {
    alert('Silakan login terlebih dahulu untuk menambahkan ke favorit!');
    return;
  }

  const wisataId = icon.getAttribute('data-id');  // Ambil ID wisata
  const userId = JSON.parse(atob(token.split('.')[1])).id;  // Mendekode JWT dan ambil userId

  const isFavorited = icon.classList.contains("fa-solid"); // Cek apakah sudah ada di favorit

  // Jika belum difavoritkan, tambahkan ke favorit
  if (!isFavorited) {
    fetch(`http://localhost:5000/api/favorite/${userId}/${wisataId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ userId, wisataId })
    })
      .then(response => response.json())
      .then(data => {
        // Setelah menambah, ubah ikon menjadi berwarna
        icon.classList.add("fa-solid");
        icon.classList.remove("fa-regular");
      })
      .catch(error => {
        console.error("Error adding to favorite:", error);
      });
  } else {
    // Jika sudah difavoritkan, hapus dari favorit
    fetch(`http://localhost:5000/api/favorite/${userId}/${wisataId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
      .then(response => response.json())
      .then(data => {
        // Setelah menghapus, ubah ikon menjadi abu-abu
        icon.classList.add("fa-regular");
        icon.classList.remove("fa-solid");
      })
      .catch(error => {
        console.error("Error removing from favorite:", error);
      });
  }
}
</script>



  </body>

</html>
